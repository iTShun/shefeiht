<?php

require_once 'AppDatas.php';
require_once 'Medoo.php';
// Using Medoo namespace
use Medoo\Medoo;

/*
开发表操作功能：添加、查询、上传
*/
class ExploitTable
{
	protected $database_table_name = 'exploit_table';

	public function __construct()
	{
		global $app;
		try {
		$sql = "CREATE TABLE IF NOT EXISTS `" . $this->tableName() . "`(
			   `u_id` bigint not null comment 'ID' primary key,
			   `g_id`  tinyint not null comment '组别',
			   `e_name` varchar(8) comment '开发者',
			   `name` varchar(8) comment '名字',
			   `phone` varchar(20) not null comment '电话',
			   `wechat` varchar(30) comment '微信号',
			   `addr` varchar(80) comment '地址',
			   `desc` varchar(32) comment '描述',
			   `control` varchar(32) comment '操作状态',
			   `source` varchar(8) comment '来源',
			   `time` datetime comment '时间'
			)AUTO_INCREMENT=0 ENGINE=MyISAM DEFAULT CHARSET=utf8;";
			//InnoDB: 读少、写多。 MyISAM: 读多、写少。
			$app['db_database']->query( $sql )->fetchAll();
		}
		catch (PDOException $e) {
			throw new Exception($e->getMessage());
		}
	}

	public function tableName()
	{
		return $this->database_table_name;
	}

	public function check($condition = null)
	{
		global $app;
		$datas = null;
		if ($condition)
			$datas = $app['db_database']->select($this->tableName(), '*', $condition);
		else
			$datas = $app['db_database']->select($this->tableName(), '*', array("ORDER" => array("time" => "DESC")));

		if ($datas && is_array($datas))
			return $datas;
		
		return null;
	}

	public function insert($datas)
	{
		global $app;
		$app['db_database']->insert($this->tableName(), $datas);
	}
	
	public function update($datas, $condition)
	{
		global $app;
		if ($condition)
			$app['db_database']->update($this->tableName(), $datas, $condition);
	}

	public function upload($files)
	{
		if (isset($files["file"]["name"]))
		{
			// 允许上传的文件后缀
			$allowedExts = array("jpg");
			//默认路径
			$path = "../upload/";

			$fileName = pathinfo($files["file"]["name"], PATHINFO_BASENAME);
			$extension = strtolower(pathinfo($files["file"]["name"], PATHINFO_EXTENSION));

			if (in_array($extension, $allowedExts)
				&& $files["file"]["size"] < (1024 * 1024))   // 小于 1024 kb (1MB)
			{
				 if ($files["file"]["error"] > 0)
			    {
			       return "错误: " . $files["file"]["error"];
			    }
			    else
			    {
			    	// 判断当期目录下的 upload 目录是否存在该文件
			        // 如果没有 upload 目录，你需要创建它，upload 目录权限为 777
			        if (!file_exists($path))
			        {
			        	//创建目录
			        	mkdir($path);
			        }

			        if (!file_exists($path . $files["file"]["name"]))
			        {
			            // 如果 upload 目录不存在该文件则将文件上传到 upload 目录下
			            move_uploaded_file($files["file"]["tmp_name"], $path . $files["file"]["name"]);
			            return array('name'=>$fileName, 'ext'=>$extension, 'path'=>$path);
			        }
			        else
			        {
			            return '文件已经存在!';
			        }
			    }
			}
			else
			{
				return '未知文件格式!';
			}
		}

		return '上传文件失败!';
	}
}

?>